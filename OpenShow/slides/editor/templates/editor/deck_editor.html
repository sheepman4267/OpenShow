{% extends 'core/base.html' %}

{% load static %}
{% load icon %}

{% block title %}
    Editing {{ deck.name }} - OpenShow
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'slides/slide-thumbnail.css' %}">
    <link rel="stylesheet" href="{% static 'editor/editor-extras.css' %}">
{% endblock %}

{% block header %}
    <h1>{{ deck.name }}</h1>
{% endblock %}

{% block header_right_button %}
    <a href="{% url 'delete-deck' deck.pk %}" class="icon-button" aria-label="Edit {{ deck.name }}">{% icon 'trash-2' %}</a>
{% endblock %}

{% block header_left_button %}
    <a href="{% url 'deck' deck.pk %}" class="icon-button" aria-label="Back to {{ deck.name }}">{% icon 'arrow-left' %}</a>
{% endblock %}

{% block main %}
    <div id="view-container" class="sidebar-layout single">
        <div class="mobile-hidden box">
            <ul class="slides-sidebar" id="slides-sidebar">
                {% for slide in deck.slides.all %}
                    <form
                        class="dragbox"
                        hx-post="{% url 'reorder-slide' %}"
                        hx-swap="outerHTML"
                        hx-trigger="drop"
                        hx-select=".slides-sidebar"
                        hx-target=".slides-sidebar"
                        _="
                        on dragover or dragenter call event.preventDefault() then add .dragover to me
                        on dragleave remove .dragover from me
                    ">
                        {% csrf_token %}
                        <input type="hidden" name="deck_or_segment_pk" value="{{ deck.pk }}">
                        <input type="hidden" name="next_slide_pk" value="{{ slide.pk }}">
                        <input type="hidden" name="moved_slide_pk" class="movedslide">
                    </form>
                    <li class="slide-thumbnail"
                        hx-get="{% url 'edit-slide' pk=slide.pk %}"
                        hx-swap="outerHTML"
                        hx-select="#editor"
                        hx-target="#editor"
                        draggable="true"
                        data-slide-pk="{{ slide.pk }}"
                        _="on dragstart
                        call event.dataTransfer.setData('text/plain',target) {# don't know why, drop event never fires unless something is set here #}
                        then set @value of <input[name='moved_slide_pk']/> to my @data-slide-pk"
                    >
                        <a href="{% url 'edit-slide' slide.pk %}" title="Edit this slide">
                            {% include "slides/slide-thumbnail.html" with slide=slide %}
                        </a>
                    </li>
                {% endfor %}
                    <form
                        class="dragbox"
                        hx-post="{% url 'reorder-slide' %}"
                        hx-swap="outerHTML"
                        hx-trigger="drop"
                        hx-select=".slides-sidebar"
                        hx-target=".slides-sidebar"
                        _="
                        on dragover or dragenter call event.preventDefault() then add .dragover to me
                        on dragleave remove .dragover from me
                    ">
                        {% csrf_token %}
                        <input type="hidden" name="deck_or_segment_pk" value="{{ deck.pk }}">
                        {# don't sent next_slide as this is the end #}
                        <input type="hidden" name="moved_slide_pk" class="movedslide">
                    </form>
                <li>
                    <form>
                        {% csrf_token %}
                        <input type="hidden" name="deck" value="{{ deck.pk }}">
                        <button
                                hx-post="{% url 'new-slide' %}"
                                hx-select="#slides-sidebar"
                                hx-target="#slides-sidebar"
                                hx-trigger="click"
                        >
                            New Slide
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    {% block editor-right %}
        <div id="editor-right" class="deck">
            <div id="aoml-buttons">
                <a href="{% url 'push-deck-text' deck.pk %}" title="Push AOML to slides">
                    <button>{% icon 'arrow-left' %}</button>
                </a>
                <a href="{% url 'pull-aoml-text' deck.pk %}" title="Pull AOML from slides">
                    <button>{% icon 'arrow-right' %}</button>
                </a>
            </div>
            <form
                    hx-trigger="change throttle:2s"
                    hx-post="{% url 'edit-deck' deck.pk %}"
                    hx-swap="outerHTML"
                    hx-select="#view-container"
                    hx-target="#view-container"
                    class="deck-form"
            >
                {% csrf_token %}
                <div class="double-box-container">
                <fieldset class="box">
                    <strong class="titlebar block">General Options</strong>
                    <label class="block">Deck Name: {{ form.name }}</label>
                    <label class="block">Theme: {{ form.theme }}</label>
                    <label class="block">Default Transition: {{ form.default_transition }}</label>
                    <label class="block">Default Transition Duration: {{ form.default_transition_duration }}</label>
                </fieldset>
                <fieldset class="box">
                    <strong class="titlebar block">Auto Advance Options</strong>
                    <label class="block">Auto Advance {{ form.default_auto_advance }}</label>
                    <label class="block">Advance In Loop (only when not in a show) {{ form.advance_in_loop }}</label>
                    <label class="block">Auto Advance Duration {{ form.default_auto_advance_duration }}</label>
                </fieldset>
                </div>
                <div class="box aoml-editor">
                    <strong class="titlebar block">AOML Slide Text</strong>
                    {{ form.slide_text_markup }}
                </div>
                {{ form.errors }}
            </form>
        </div>
    {% endblock %}
</div>
{% endblock %}